{% extends 'base.html' %}
{% block content %}
{% load static %}
{% include 'navbar.html' %}

<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
  <header class="mb-6">
    <h1 class="text-3xl font-bold tracking-tight text-gray-900">Treble Eshop: Game On, Style On</h1>
    <p class="text-gray-600">Welcome back, {{ name }} — NPM {{ npm }} • Class {{ class }}</p>
  </header>
  
  <!-- Filter Bar -->
  <div class="mb-6 rounded-2xl bg-white ring-1 ring-gray-200 p-3">
    <!-- mobile: 1 kolom (tombol di atas, last-login di bawah)
        ≥sm: 2 kolom (tombol kiri melebar, last-login kanan) -->
    <div class="grid gap-3 sm:grid-cols-[1fr_auto] sm:items-center">
      
      <!-- Wadah tombol -->
      <div class="w-full">
        <!-- Dua tombol = dua kolom sama lebar, full width -->
        <div class="grid grid-cols-2 gap-2 w-full">
          <a href="?filter=all"
            class="inline-flex w-full justify-center items-center
                    rounded-lg px-3 py-2 text-sm font-medium whitespace-nowrap
                    ring-1 ring-gray-300 hover:bg-gray-50
                    {% if request.GET.filter != 'my' %} bg-[--color-button]/10 text-[--color-button] ring-[--color-button]/30 {% endif %}">
            All Products
          </a>

          <a href="?filter=my"
            class="inline-flex w-full justify-center items-center
                    rounded-lg px-3 py-2 text-sm font-semibold whitespace-nowrap
                    ring-1 ring-gray-300 hover:bg-gray-50
                    {% if request.GET.filter == 'my' %} bg-[--color-button]/10 text-[--color-button] ring-[--color-button]/30 {% endif %}">
            My Products
          </a>
        </div>
      </div>

      <!-- Last login -->
      <div class="text-sm text-gray-500
         text-center sm:text-right
         justify-self-center sm:justify-self-end
         mt-2 sm:mt-0">
        Last login: {{ last_login|default:"Never" }}
      </div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="flex items-center gap-2 mb-4">
    <button id="btnRefresh" class="px-3 py-2 rounded-md border">Refresh</button>
  </div>

  <!-- States -->
  <div id="loading" class="hidden text-gray-600">Loading products…</div>
  <div id="error" class="hidden text-rose-700"></div>
  <div id="grid" class="hidden"></div>
  <div id="empty" class="hidden text-gray-600">Belum ada product.</div>

  <!-- Modal Create Product -->
  <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
    <!-- Modal: Product Form -->
    <div id="productModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
      <div class="w-full max-w-lg rounded-2xl bg-white shadow-xl overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <h3 id="productModalTitle" class="font-semibold">Create Product</h3>
          <button class="text-gray-500 hover:text-gray-700" onclick="closeProductModal()">×</button>
        </div>
        <form id="productForm" class="p-4 space-y-3">
          <input type="hidden" name="id" />
          {% csrf_token %}
          <label class="block text-sm">Nama
            <input name="name" required maxlength="100" class="mt-1 w-full rounded-lg border px-3 py-2" />
          </label>
          <label class="block text-sm">Harga
            <input name="price" type="number" step="1" min="0" required class="mt-1 w-full rounded-lg border px-3 py-2" />
          </label>
          <label class="block text-sm">Stock
            <input name="stock" type="number" min="0" required class="mt-1 w-full rounded-lg border px-3 py-2" />
          </label>
          <label class="block text-sm">Thumbnail (URL)
            <input name="thumbnail" class="mt-1 w-full rounded-lg border px-3 py-2" />
          </label>
          <label class="block text-sm">Deskripsi
            <textarea name="description" rows="3" class="mt-1 w-full rounded-lg border px-3 py-2"></textarea>
          </label>
          <div class="flex justify-end gap-2 pt-2 border-t">
            <button type="button" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center" onclick="closeProductModal()">Batal</button>
            <button type="submit" class="order-1 sm:order-2 flex-1 bg-[--color-button] text-white px-6 py-3 rounded-md font-medium hover:bg-[--color-button-hover] transition-colors">Simpan</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal: Confirm Delete -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
      <div class="w-full max-w-md rounded-2xl bg-white shadow-xl overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <h3 class="font-semibold">Hapus Product?</h3>
          <button class="text-gray-500 hover:text-gray-700" onclick="closeConfirmModal()">×</button>
        </div>
        <div class="p-4"><p id="confirmText">Yakin ingin menghapus?</p></div>
        <div class="flex justify-end gap-2 px-4 py-3 border-t">
          <button class="px-3 py-2 rounded-lg border" onclick="closeConfirmModal()">Batal</button>
          <button id="btnConfirmDelete" class="px-3 py-2 rounded-lg text-white bg-rose-600 hover:bg-rose-700">Hapus</button>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Delete confirmation modal (untuk tombol Delete) -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden">
  <!-- backdrop -->
  <div data-close class="absolute inset-0 bg-black/40"></div>

  <!-- dialog -->
  <div class="absolute inset-0 grid place-items-center p-4">
    <div role="dialog" aria-modal="true" aria-labelledby="delTitle"
         class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl ring-1 ring-black/5">
      <h3 id="delTitle" class="text-lg font-semibold text-gray-900">Delete product?</h3>
      <p class="mt-2 text-sm text-gray-600">
        Are you sure you want to delete <span id="delName" class="font-medium"></span>? This action can’t be undone.
      </p>

      <form id="deleteForm" method="POST" class="mt-6 flex justify-end gap-3">
        {% csrf_token %}
        <button type="button" data-close
                class="rounded-lg px-4 py-2 ring-1 ring-gray-300 text-gray-700 hover:bg-gray-50">
          Cancel
        </button>
        <button type="submit"
                class="rounded-lg bg-red-600 px-4 py-2 font-semibold text-white hover:bg-red-500">
          Delete
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Khusus agar modal tombol Delete bekerja, yang sudah lama -->
<!-- <script>
(() => {
  const modal = document.getElementById('deleteModal');
  const form  = document.getElementById('deleteForm');
  const nameEl = document.getElementById('delName');

  function openModal(url, name) {
    form.action = url;
    nameEl.textContent = name || 'this product';
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }
  function closeModal() {
    modal.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // open
  document.querySelectorAll('.js-open-delete').forEach(btn => {
    btn.addEventListener('click', () => openModal(btn.dataset.url, btn.dataset.name));
  });

  // close on backdrop / cancel
  modal.addEventListener('click', e => {
    if (e.target.hasAttribute('data-close')) closeModal();
  });
  window.addEventListener('keydown', e => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
  });
})();
</script> -->

<!-- Footer Pembuatan Website -->
<footer class="mt-10 border-t border-gray-200 py-6">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col items-center text-sm text-gray-500">
      <p class="order-2 sm:order-1">&copy; {% now "Y" %} Treble Eshop. All rights reserved. Made by Neal & Aloe Vera</p>
    </div>
  </div>
</footer>

<script>
  // ===== Konstanta endpoint (pakai URL tag) =====
  const PRODUCTS_API_ENDPOINT = "{% url 'main:show_json' %}";
  const CREATE_API = "{% url 'main:add_product_entry_ajax' %}";
  const EDIT_API   = (id) => "{% url 'main:edit_product_entry_ajax' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', id);
  const DELETE_API = (id) => "{% url 'main:delete_product_ajax' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', id);

  // Ganti ini dengan nama route detail kamu jika beda:
  const DETAIL_HREF_TEMPLATE = "{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}";
  const detailHref = (id) => DETAIL_HREF_TEMPLATE.replace('00000000-0000-0000-0000-000000000000', id);

  // ===== DOM =====
  const loading = document.getElementById('loading');
  const errorEl = document.getElementById('error');
  const emptyEl = document.getElementById('empty');
  const grid    = document.getElementById('grid');

  function displaySection({ showLoading=false, showError=false, showEmpty=false, showGrid=false }) {
    loading.classList.toggle('hidden', !showLoading);
    errorEl.classList.toggle('hidden', !showError);
    emptyEl.classList.toggle('hidden', !showEmpty);
    grid.classList.toggle('hidden', !showGrid);
    if (showGrid) grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
  }

  // Build card (Details · Edit · Delete), sanitize pakai DOMPurify
  function buildProductCard(item){
    const rating = Math.max(0, Math.min(5, Number(item.rating||0)));
    const ratingPct = (rating/5)*100;
    const views = Number(item.product_views||0);

    const article = document.createElement('article');
    article.className = "group relative flex h-full flex-col overflow-hidden rounded-2xl bg-white ring-1 ring-gray-200 shadow-sm transition duration-200 hover:-translate-y-0.5 hover:shadow-lg";
    article.dataset.id = item.id;

    const thumbHtml = item.thumbnail
      ? `<img src="${DOMPurify.sanitize(item.thumbnail)}" alt="${DOMPurify.sanitize(item.name)}"
              class="h-full w-full object-cover object-center transition duration-300 group-hover:scale-105" />`
      : `<div class="flex h-full w-full items-center justify-center text-sm text-gray-500">No Image</div>`;

    const hotBadge = item.is_product_hot
      ? `<span class="absolute left-3 top-3 inline-flex items-center rounded-full
                      bg-pink-50 px-2 py-0.5 text-xs font-semibold border-pink-300 text-pink-700
                      ring-1 ring-pink-200">Hot 🔥</span>`
      : ``;

    
    const detailsHref = detailHref(item.id); // sudah kamu definisikan sebelumnya

    // tombol Edit/Delete hanya kalau owner
    const ownerAction = item.is_owner ? `
        <a href="#" data-edit="${item.id}"
          class="z-10 inline-flex items-center justify-center rounded-lg
                  px-3 py-1.5 text-sm font-semibold text-gray-700
                  ring-1 ring-gray-300 hover:bg-gray-50">
          Edit
        </a>
        <button type="button"
                data-del="${item.id}"
                data-name="${DOMPurify.sanitize(item.name)}"
                class="z-10 ml-2 inline-flex items-center justify-center rounded-lg
                      px-3 py-1.5 text-sm font-semibold text-red-600
                      ring-1 ring-red-200 hover:bg-red-50">
          Delete
        </button>
      ` : ``;

    article.innerHTML = `
      <!-- Cover/Thumbnail -->
      <div class="relative aspect-[4/3] overflow-hidden rounded-t-2xl bg-gray-100">
        ${thumbHtml}
        ${hotBadge}
      </div>

      <!-- Body -->
      <div class="flex flex-1 flex-col p-4 gap-3">
        <h3 class="text-base font-semibold text-gray-900 line-clamp-1">
          <a href="${detailsHref}" class="hover:underline">
            ${DOMPurify.sanitize(item.name)}
          </a>
        </h3>

        <!-- Price -->
        <div class="text-lg font-semibold text-gray-900">
          ${rupiah(item.price)}
        </div>

        <!-- Optional small meta (tanggal) -->
        <div class="text-xs text-gray-500">${fmtDate(item.created_at)}</div>

        <!-- Description -->
        <p class="text-sm text-gray-600 line-clamp-2">
          ${DOMPurify.sanitize(item.description || '')}
        </p>

        <!-- Rating + Views -->
        <div class="mt-auto">
          <div class="flex items-center justify-between text-sm text-gray-500">
            <!-- Stars -->
            <div class="inline-flex items-center gap-2" aria-label="Rating ${rating} out of 5">
              <span class="relative inline-block leading-none">
                <span class="text-gray-300 select-none">★★★★★</span>
                <span class="absolute inset-0 overflow-hidden text-amber-500 select-none"
                      style="width: ${ratingPct}%;">
                  ★★★★★
                </span>
              </span>
              <span class="text-gray-700">${rating}/5</span>
            </div>

            <span class="inline-flex items-center gap-1">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              ${views}
            </span>
          </div>

          <!-- Actions -->
          <div class="pt-3 justify-between">
            <a href="${detailsHref}"
              class="z-10 inline-flex items-center justify-center rounded-lg
                      bg-[--color-button] px-3 py-1.5 text-sm font-semibold text-white
                      hover:bg-[--color-button-hover]">
              Details
            </a>
            ${ownerAction}
          </div>
        </div>
      </div>
    `;

    return article;
  }

  // FETCH list
  function getCSRF() {
    return (
      document.cookie.match(/csrftoken=([^;]+)/)?.[1] ||
      document.querySelector('input[name=csrfmiddlewaretoken]')?.value ||
      ''
    );
  }
  async function fetchProducts(){
    displaySection({ showLoading:true });
    grid.innerHTML = '';
    try{
      // ← baca filter dari URL (?filter=my | ?filter=all | kosong)
      const isMine = new URLSearchParams(window.location.search).get('filter') === 'my';

      // ← tambahkan ?mine=1 ke endpoint JSON kalau My Products
      const res  = await fetch(PRODUCTS_API_ENDPOINT + (isMine ? '?mine=1' : ''));
      const data = await res.json(); // array

      if (!Array.isArray(data) || data.length === 0){
        displaySection({ showEmpty:true }); return;
      }
      grid.innerHTML = '';
      data.forEach(item => grid.appendChild(buildProductCard(item)));
      displaySection({ showGrid:true });
    }catch(err){
      errorEl.textContent = err?.message || 'Gagal memuat';
      displaySection({ showError:true });
    }
  }
  document.getElementById('btnRefresh')?.addEventListener('click', fetchProducts);
  
  // Untuk bisa filter My Product atau All Products
  document.addEventListener('DOMContentLoaded', fetchProducts);

  // Bersih sejak awal
  const clean = (s) => typeof s === 'string' ? s.replace(/\u00A0/g, ' ').trim() : s;
  // Modal helpers
  function openProductModal(prod=null){
    const m = document.getElementById('productModal');
    const f = document.getElementById('productForm');
    f.reset();
    f.elements.id.value = prod?.id || '';
    f.elements.name.value = prod?.name || '';
    f.elements.price.value = prod?.price ?? '';
    f.elements.stock.value = prod?.stock ?? '';
    f.elements.thumbnail.value = prod?.thumbnail || '';
    f.elements.description.value = prod?.description || '';
    document.getElementById('productModalTitle').textContent = prod ? 'Update Product' : 'Create Product';
    m.classList.remove('hidden'); m.classList.add('flex');
  }
  // Pastikan fungsi bisa diakses dari tombol navbar di base.html
  window.openProductModal = openProductModal;

  // Ketika datang dari navbar (redirect dengan ?create=1), buka modal otomatis
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    if (params.get('create') === '1') {
      openProductModal();
      // Opsional: hapus param dari URL biar rapi
      params.delete('create');
      const next = params.get('next'); // kalau kamu mau pakai nanti
      const qs = params.toString();
      history.replaceState({}, '', window.location.pathname + (qs ? '?' + qs : ''));
    }
  });

  // Tutup Modal
  function closeProductModal(){ 
    const m = document.getElementById('productModal'); 
    m.classList.add('hidden'); 
    m.classList.remove('flex'); 
  }

  // Confirm Modal
  function openConfirmModal(id, name){
    const m = document.getElementById('confirmModal');
    document.getElementById('confirmText').textContent = `Hapus "${name}"?`;
    m.dataset.id = id;
    m.classList.remove('hidden'); 
    m.classList.add('flex');
  }

  function closeConfirmModal(){ 
    const m=document.getElementById('confirmModal'); 
    m.classList.add('hidden'); 
    m.classList.remove('flex'); 
    m.dataset.id=''; 
  }

  // CREATE/UPDATE → langsung append/replace DOM (tanpa refetch)
  async function addOrUpdateProduct(fd){
    const id  = fd.get('id');
    const url = id ? EDIT_API(id) : CREATE_API;

    const res = await fetch(url, {
      method: 'POST',
      body: fd,                    // sudah ada csrfmiddlewaretoken dari form
      credentials: 'same-origin',  // kirim cookie session
    });

    
    if(!res.ok){
      let msg='Gagal menyimpan';
      try{ const j=await res.json(); msg=j?.error||msg; }catch{}
      throw new Error(msg);
    }
    const item = await res.json(); // JSON item (balasan view)

    // pastikan grid tampil
    emptyEl.classList.add('hidden');
    grid.classList.remove('hidden');
    grid.classList.add('grid','grid-cols-1','md:grid-cols-2','lg:grid-cols-3','gap-6');

    if (!id){
      grid.prepend(buildProductCard(item));
      showToast('Tersimpan', 'Product dibuat', 'success');
    } else {
      const old = grid.querySelector(`[data-id="${item.id}"]`);
      const fresh = buildProductCard(item);
      if (old) {
        old.replaceWith(fresh);
      }
      showToast('Berhasil', 'Product diupdate', 'success');
    }
    closeProductModal();
  }

  // Submit form product
  document.getElementById('productForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    try{
      await addOrUpdateProduct(new FormData(e.target));
    }catch(err){
      showToast('Gagal', err?.message || 'Gagal menyimpan', 'error');
    }
  });

  // DELETE → remove DOM
  document.getElementById('btnConfirmDelete')?.addEventListener('click', async () => {
    const m = document.getElementById('confirmModal');
    const id = m.dataset.id;
    if (!id) return;

    try {
      const res = await fetch(DELETE_API(id), {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRF() },   // ⬅️ penting untuk lolos CSRF
        body: new FormData(),                    // POST body (boleh kosong)
        credentials: 'same-origin',              // kirim cookie session
      });

      if (!res.ok) {
        let msg = `Gagal menghapus (HTTP ${res.status})`;
        try { msg += ` — ${(await res.text()).slice(0,120)}`; } catch {}
        showToast('Delete', msg, 'error');
        return;
      }

      const j = await res.json();                           // { ok:true, id:'...' }
      document.getElementById('grid')
        .querySelector(`[data-id="${j.id}"]`)?.remove();

      if (!document.getElementById('grid').children.length){
        document.getElementById('grid').classList.add('hidden');
        document.getElementById('empty').classList.remove('hidden');
      }
      showToast('Dihapus', 'Product dihapus', 'success');
    } catch (e) {
      showToast('Delete', e?.message || 'Gagal menghapus', 'error');
    } finally {
      m.dataset.id = '';
      closeConfirmModal();
    }
  });

  // Delegasi tombol Edit/Delete yang ada dari card
  grid.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-edit], [data-del]');
    if (!btn) return;

    if (btn.dataset.edit){
      const card = btn.closest('[data-id]');

      const name = (card.querySelector('h3 a')?.textContent ?? '').trim();
      const desc = (card.querySelector('p.text-sm.text-gray-600')?.textContent ?? '').trim();
      const price = Number((card.querySelector('.text-lg.font-semibold')?.textContent || '').replace(/[^\d]/g,'')) || 0;
      const stock = Number((card.textContent.match(/Stock:\s*(\d+)/)||[])[1]||0) || 0;
      const thumbnail = (card.querySelector('img')?.getAttribute('src') || '').trim();

      openProductModal({ id: btn.dataset.edit, name, description: desc, price, stock, thumbnail });
      return;
    }

    if (btn.dataset.del){
      openConfirmModal(btn.dataset.del, btn.dataset.name || '');
      return;
    }
  });

  // Helper supaya format uangnya bagus
  function rupiah(n){
    const v = Number(n||0);
    // mirip {{ product.price_in_rupiah }}
    return v.toLocaleString('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 });
  }
  function fmtDate(iso){
    if(!iso) return '';
    const d = new Date(iso);
    // mirip format "M d, Y" (Jan 02, 2025)
    return d.toLocaleDateString('en-US', { month:'short', day:'2-digit', year:'numeric' });
  }

  // Aktifkan toast jika datang dengan ?toast=login
  document.addEventListener("DOMContentLoaded", () => {
    const p = new URLSearchParams(location.search);
    if (p.get("toast") === "login") {
      showToast("Login", "Selamat datang kembali", "success");
      p.delete("toast");
      history.replaceState({}, "", location.pathname + (p.toString() ? "?" + p.toString() : ""));
    }
  });
  
</script>


{% endblock content %}